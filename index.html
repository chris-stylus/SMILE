<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smile Detector Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen">
    <h1 class="text-3xl font-bold mb-4">AI Smile LED Controller</h1>
    
    <div class="relative w-[400px] h-[300px] bg-black rounded-lg overflow-hidden border-4 border-blue-500">
        <video id="input_video" class="w-full h-full object-cover"></video>
        <div id="status_box" class="absolute top-2 left-2 px-3 py-1 rounded bg-red-600 font-bold">NO SMILE</div>
    </div>

    <div class="mt-6 flex gap-4">
        <button onclick="manualSet(1)" class="bg-green-600 px-4 py-2 rounded">Force Green</button>
        <button onclick="manualSet(0)" class="bg-red-600 px-4 py-2 rounded">Force Red</button>
    </div>

    <script>
        // REPLACE THESE with your actual project info
        const firebaseConfig = {
            apiKey: "AIzaSyBfg4l53OaR2HYbO5rv2TmKBGnsb-VktK0",
            databaseURL: "https://smile-dd182-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        function manualSet(val) {
            database.ref('smileStatus').set(val)
                .then(() => console.log("Database updated to: " + val))
                .catch(err => console.error("Firebase Error: ", err));
        }

        const videoElement = document.getElementById('input_video');
        const statusBox = document.getElementById('status_box');

        const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
        faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5 });

        faceMesh.onResults((results) => {
            if (results.multiFaceLandmarks && results.multiFaceLandmarks[0]) {
                const points = results.multiFaceLandmarks[0];
                
                // Detection: Distance between top and bottom inner lip
                const lipDist = Math.abs(points[13].y - points[14].y);
                const isSmiling = lipDist > 0.025 ? 1 : 0; // Adjust 0.025 if needed

                if (isSmiling) {
                    statusBox.innerText = "SMILE!";
                    statusBox.className = "absolute top-2 left-2 px-3 py-1 rounded bg-green-600 font-bold";
                } else {
                    statusBox.innerText = "NO SMILE";
                    statusBox.className = "absolute top-2 left-2 px-3 py-1 rounded bg-red-600 font-bold";
                }
                
                // Send to Firebase
                database.ref('smileStatus').set(isSmiling);
            }
        });

        const camera = new Camera(videoElement, {
            onFrame: async () => { await faceMesh.send({image: videoElement}); },
            width: 640, height: 480
        });
        camera.start();
    </script>
</body>
</html>
