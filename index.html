<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smile Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .video-flip { transform: scaleX(-1); }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center p-4 md:p-8">

    <header class="text-center mb-10">
        <h1 class="text-4xl md:text-6xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-500">
            SMILE DETECTOR
        </h1>
        <p class="text-slate-400 mt-2">Control your ESP8266 LEDs with your smile</p>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full max-w-6xl">
        
        <div class="relative rounded-3xl overflow-hidden border-4 border-slate-700 shadow-2xl bg-black aspect-video">
            <video id="webcam" class="w-full h-full object-cover video-flip" autoplay playsinline></video>
            <div id="overlay" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div id="status-ring" class="w-48 h-48 border-4 border-dashed border-cyan-500/50 rounded-full animate-spin-slow"></div>
            </div>
        </div>

        <div class="flex flex-col gap-6">
            <div id="status-card" class="glass rounded-3xl p-8 flex-1 transition-all duration-500">
                <h2 class="text-xl text-slate-300 font-semibold mb-2">System Status</h2>
                <div class="flex items-center gap-4">
                    <div id="status-indicator" class="w-6 h-6 rounded-full bg-red-500 shadow-[0_0_15px_rgba(239,68,68,0.5)]"></div>
                    <span id="status-text" class="text-3xl font-bold italic tracking-wider">WAITING...</span>
                </div>
                
                <div class="mt-8 grid grid-cols-2 gap-4">
                    <div class="bg-white/5 p-4 rounded-2xl text-center">
                        <span class="block text-xs text-slate-400 uppercase">Green LED</span>
                        <span id="green-label" class="text-lg font-bold">OFF</span>
                    </div>
                    <div class="bg-white/5 p-4 rounded-2xl text-center">
                        <span class="block text-xs text-slate-400 uppercase">Red LED</span>
                        <span id="red-label" class="text-lg font-bold">ON</span>
                    </div>
                </div>
            </div>

            <div class="glass rounded-3xl p-6">
                <h3 class="font-bold mb-2">How it works:</h3>
                <ul class="text-sm text-slate-400 space-y-2">
                    <li>• MediaPipe tracks your lip landmarks in real-time.</li>
                    <li>• Data is synced to Firebase RTDB.</li>
                    <li>• ESP8266 D3 (Green) and D4 (Red) react instantly.</li>
                </ul>
            </div>
        </div>
    </main>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBfg4l53OaR2HYbO5rv2TmKBGnsb-VktK0",
            databaseURL: "https://smile-dd182-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- ELEMENTS ---
        const video = document.getElementById('webcam');
        const statusText = document.getElementById('status-text');
        const statusIndicator = document.getElementById('status-indicator');
        const statusCard = document.getElementById('status-card');
        const greenLabel = document.getElementById('green-label');
        const redLabel = document.getElementById('red-label');

        // --- MEDIA PIPE FACE MESH ---
        const faceMesh = new FaceMesh({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
        });

        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        faceMesh.onResults((results) => {
            if (results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];
                
                // Detection logic: Compare distance between upper and lower inner lip
                // Points: 13 (top lip bottom), 14 (bottom lip top)
                const topLip = landmarks[13];
                const bottomLip = landmarks[14];
                const mouthWidth = Math.abs(landmarks[61].x - landmarks[291].x);
                const lipDistance = Math.abs(topLip.y - bottomLip.y);
                
                // Ratio-based detection is better than fixed numbers
                const smileValue = lipDistance > (mouthWidth * 0.15) ? 1 : 0;

                updateUI(smileValue);
                database.ref('/').update({ smileStatus: smileValue });
            }
        });

        function updateUI(isSmiling) {
            if (isSmiling) {
                statusText.innerText = "SMILING!";
                statusIndicator.className = "w-6 h-6 rounded-full bg-green-400 shadow-[0_0_15px_rgba(74,222,128,0.5)]";
                statusCard.style.borderColor = "rgba(74,222,128,0.5)";
                greenLabel.innerText = "ON";
                greenLabel.classList.add("text-green-400");
                redLabel.innerText = "OFF";
                redLabel.classList.remove("text-red-400");
            } else {
                statusText.innerText = "NO SMILE";
                statusIndicator.className = "w-6 h-6 rounded-full bg-red-500 shadow-[0_0_15px_rgba(239,68,68,0.5)]";
                statusCard.style.borderColor = "rgba(239,68,68,0.2)";
                greenLabel.innerText = "OFF";
                greenLabel.classList.remove("text-green-400");
                redLabel.innerText = "ON";
                redLabel.classList.add("text-red-400");
            }
        }

        const camera = new Camera(video, {
            onFrame: async () => { await faceMesh.send({image: video}); },
            width: 1280, height: 720
        });
        camera.start();
    </script>
</body>
</html>
