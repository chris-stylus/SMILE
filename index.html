<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smile-to-LED Control Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- face-api.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        .video-container {
            position: relative;
            transform: scaleX(-1); /* Mirror effect for webcam */
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center p-4 md:p-8">

    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-emerald-400 mb-2">Smile-to-LED IoT System</h1>
        <p class="text-slate-400 max-w-md">Real-time facial expression recognition linked to physical hardware via Firebase.</p>
    </header>

    <main class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Video Section -->
        <div class="bg-slate-800 p-4 rounded-2xl shadow-xl border border-slate-700 flex flex-col items-center">
            <h2 class="text-lg font-semibold mb-4 self-start px-2">Live Camera Feed</h2>
            <div id="loading" class="absolute z-10 bg-slate-800 p-4 rounded-lg border border-slate-600 mt-20">
                <p class="animate-pulse">Loading AI Models...</p>
            </div>
            <div class="video-container rounded-xl overflow-hidden bg-black w-full aspect-video flex items-center justify-center">
                <video id="video" width="640" height="480" autoplay muted playsinline class="w-full h-full object-cover"></video>
            </div>
            <div class="mt-4 flex gap-4 text-sm">
                <div class="flex items-center gap-2">
                    <span id="ai-status" class="status-dot bg-yellow-500"></span>
                    <span>AI Engine</span>
                </div>
                <div class="flex items-center gap-2">
                    <span id="db-status" class="status-dot bg-red-500"></span>
                    <span>Database</span>
                </div>
            </div>
        </div>

        <!-- System Controls & Stats -->
        <div class="space-y-6">
            <!-- Expression Card -->
            <div class="bg-slate-800 p-6 rounded-2xl shadow-xl border border-slate-700">
                <h2 class="text-lg font-semibold mb-4">Expression Detection</h2>
                <div class="flex items-center justify-between bg-slate-900 p-4 rounded-xl mb-4">
                    <span class="text-slate-400">Current State</span>
                    <span id="expression-label" class="text-2xl font-black text-slate-500 uppercase tracking-widest">---</span>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-xs text-slate-400">
                        <span>Smile Confidence</span>
                        <span id="confidence-pct">0%</span>
                    </div>
                    <div class="w-full bg-slate-700 h-3 rounded-full overflow-hidden">
                        <div id="confidence-bar" class="bg-emerald-500 h-full transition-all duration-200" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- LED Proxy View -->
            <div class="bg-slate-800 p-6 rounded-2xl shadow-xl border border-slate-700">
                <h2 class="text-lg font-semibold mb-4">Physical LED States (ESP8266)</h2>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="p-4 rounded-xl bg-slate-900 border-2 transition-colors duration-300" id="green-led-box" style="border-color: #064e3b">
                        <div class="w-8 h-8 rounded-full mx-auto mb-2 shadow-lg transition-all duration-300" id="green-led-bulb" style="background: #064e3b"></div>
                        <span class="text-xs font-bold">GREEN (D3)</span>
                        <p class="text-[10px] text-slate-500">Smile Active</p>
                    </div>
                    <div class="p-4 rounded-xl bg-slate-900 border-2 transition-colors duration-300" id="red-led-box" style="border-color: #7f1d1d">
                        <div class="w-8 h-8 rounded-full mx-auto mb-2 shadow-lg transition-all duration-300" id="red-led-bulb" style="background: #7f1d1d"></div>
                        <span class="text-xs font-bold">RED (D4)</span>
                        <p class="text-[10px] text-slate-500">Neutral/No Smile</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="mt-auto py-8 text-slate-500 text-sm">
        <p>Project ID: smile-dd182 â€¢ Threshold: 0.60</p>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBfg4l53OaR2HYbO5rv2TmKBGnsb-VktK0",
            authDomain: "smile-dd182.firebaseapp.com",
            databaseURL: "https://smile-dd182-default-rtdb.firebaseio.com",
            projectId: "smile-dd182",
            storageBucket: "smile-dd182.firebasestorage.app",
            messagingSenderId: "83345671538",
            appId: "1:83345671538:web:a35b9c81c56c718cf749eb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const ledRef = ref(db, 'ledStatus');

        // UI Elements
        const video = document.getElementById('video');
        const loadingScreen = document.getElementById('loading');
        const expressionLabel = document.getElementById('expression-label');
        const confidencePct = document.getElementById('confidence-pct');
        const confidenceBar = document.getElementById('confidence-bar');
        const aiStatus = document.getElementById('ai-status');
        const dbStatus = document.getElementById('db-status');
        
        const gBox = document.getElementById('green-led-box');
        const rBox = document.getElementById('red-led-box');
        const gBulb = document.getElementById('green-led-bulb');
        const rBulb = document.getElementById('red-led-bulb');

        let lastState = { green: 0, red: 1 };
        let writeThrottle = false;

        async function init() {
            try {
                // 1. Load Face-API Models from local or relative CDN
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
                ]);

                aiStatus.classList.replace('bg-yellow-500', 'bg-emerald-500');
                loadingScreen.style.display = 'none';

                // 2. Start Video
                startVideo();

                // 3. Sync UI with Database (Listen for hardware echo)
                onValue(ledRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) updateLEDUI(data);
                    dbStatus.classList.replace('bg-red-500', 'bg-emerald-500');
                });

            } catch (err) {
                console.error("Initialization failed:", err);
                loadingScreen.innerHTML = `<p class="text-red-500 text-center">Error: ${err.message}<br>Check Console.</p>`;
            }
        }

        function startVideo() {
            navigator.mediaDevices.getUserMedia({ video: {} })
                .then(stream => { video.srcObject = stream; })
                .catch(err => console.error(err));
        }

        video.addEventListener('play', () => {
            const canvas = faceapi.createCanvasFromMedia(video);
            document.querySelector('.video-container').append(canvas);
            const displaySize = { width: video.width, height: video.height };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceExpressions();

                if (detections.length > 0) {
                    const expressions = detections[0].expressions;
                    const happyConf = expressions.happy;
                    
                    // Update Progress UI
                    confidencePct.innerText = `${Math.round(happyConf * 100)}%`;
                    confidenceBar.style.width = `${happyConf * 100}%`;

                    // Logic Check
                    if (happyConf > 0.6) {
                        expressionLabel.innerText = "Smiling!";
                        expressionLabel.classList.replace('text-slate-500', 'text-emerald-400');
                        updateDatabase(1, 0);
                    } else {
                        expressionLabel.innerText = "Neutral";
                        expressionLabel.classList.replace('text-emerald-400', 'text-slate-500');
                        updateDatabase(0, 1);
                    }

                    // Optional: Draw visuals
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                    faceapi.draw.drawDetections(canvas, resizedDetections);
                }
            }, 300); // Detect ~3 times per second
        });

        function updateDatabase(green, red) {
            // Only update if state changed AND not throttled
            if ((green !== lastState.green || red !== lastState.red) && !writeThrottle) {
                lastState = { green, red };
                writeThrottle = true;
                
                set(ledRef, { green, red })
                    .catch(e => console.error("Firebase write error", e));

                // Throttle to 300ms
                setTimeout(() => { writeThrottle = false; }, 333);
            }
        }

        function updateLEDUI(state) {
            if (state.green === 1) {
                gBox.style.borderColor = "#10b981";
                gBulb.style.background = "#10b981";
                gBulb.style.boxShadow = "0 0 15px #10b981";
            } else {
                gBox.style.borderColor = "#064e3b";
                gBulb.style.background = "#064e3b";
                gBulb.style.boxShadow = "none";
            }

            if (state.red === 1) {
                rBox.style.borderColor = "#ef4444";
                rBulb.style.background = "#ef4444";
                rBulb.style.boxShadow = "0 0 15px #ef4444";
            } else {
                rBox.style.borderColor = "#7f1d1d";
                rBulb.style.background = "#7f1d1d";
                rBulb.style.boxShadow = "none";
            }
        }

        window.onload = init;
    </script>
</body>
</html>
