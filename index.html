<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smile-to-LED Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <!-- face-api.js for AI detection -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .video-flip { transform: scaleX(-1); }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-4 md:p-8 selection:bg-indigo-500">

    <!-- Header -->
    <header class="max-w-4xl mx-auto mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold bg-gradient-to-r from-green-400 to-emerald-500 bg-clip-text text-transparent flex items-center gap-2">
                <span id="header-icon">üòä</span>
                Smile-to-LED Control
            </h1>
            <p class="text-slate-400 mt-1">IoT Facial Expression Integration</p>
        </div>
        <div class="flex items-center gap-3 bg-slate-800 p-3 rounded-2xl border border-slate-700 shadow-xl">
            <div class="flex items-center gap-2">
                <div id="status-dot" class="w-3 h-3 rounded-full bg-red-500"></div>
                <span id="status-text" class="text-sm font-medium text-slate-300">Initializing...</span>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Camera Feed -->
        <div class="lg:col-span-7 flex flex-col gap-4">
            <div class="relative aspect-video bg-black rounded-3xl overflow-hidden shadow-2xl border-4 border-slate-800 group">
                <div id="camera-placeholder" class="absolute inset-0 flex flex-col items-center justify-center gap-4 text-slate-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 opacity-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <p>Waiting for Camera...</p>
                </div>
                <video id="video" autoplay muted class="w-full h-full object-cover video-flip hidden"></video>
                <div id="smile-overlay" class="absolute top-4 right-4 bg-green-500/20 backdrop-blur-md border border-green-500/50 p-3 rounded-full animate-bounce hidden">
                    <span class="text-2xl">üòä</span>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 flex flex-col items-center justify-center gap-2">
                    <span class="text-xs uppercase tracking-widest text-slate-500 font-bold">Network SSID</span>
                    <div class="flex items-center gap-2 text-indigo-400 font-mono">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.757 8.929c5.857-5.857 15.355-5.857 21.213 0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        <span>UPS-4G</span>
                    </div>
                </div>
                <div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 flex flex-col items-center justify-center gap-2">
                    <span class="text-xs uppercase tracking-widest text-slate-500 font-bold">Database</span>
                    <div class="flex items-center gap-2 text-emerald-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                        <span class="text-sm">Realtime Live</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Control -->
        <div class="lg:col-span-5 space-y-6">
            <div class="bg-slate-800/50 rounded-3xl p-6 border border-slate-700 shadow-lg backdrop-blur-sm">
                <h2 class="text-lg font-semibold mb-6 flex items-center gap-2 text-indigo-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" /></svg>
                    Hardware Status
                </h2>

                <div class="space-y-6">
                    <!-- Green LED Card -->
                    <div id="green-card" class="flex items-center justify-between p-4 bg-slate-900/50 rounded-2xl border border-slate-700 transition-all duration-300">
                        <div class="flex items-center gap-4">
                            <div id="green-led-icon" class="w-12 h-12 rounded-xl flex items-center justify-center bg-slate-800 text-slate-500 transition-all duration-500">
                                <span class="text-xl">üòä</span>
                            </div>
                            <div>
                                <p class="font-bold">Green LED</p>
                                <p class="text-xs text-slate-500 uppercase">Pin D3 (GPIO0)</p>
                            </div>
                        </div>
                        <div id="green-status-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-slate-800 text-slate-600 transition-all">
                            OFF
                        </div>
                    </div>

                    <!-- Red LED Card -->
                    <div id="red-card" class="flex items-center justify-between p-4 bg-slate-900/50 rounded-2xl border border-slate-700 transition-all duration-300">
                        <div class="flex items-center gap-4">
                            <div id="red-led-icon" class="w-12 h-12 rounded-xl flex items-center justify-center bg-slate-800 text-slate-500 transition-all duration-500">
                                <span class="text-xl">üòê</span>
                            </div>
                            <div>
                                <p class="font-bold">Red LED</p>
                                <p class="text-xs text-slate-500 uppercase">Pin D4 (GPIO2)</p>
                            </div>
                        </div>
                        <div id="red-status-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-slate-800 text-slate-600 transition-all">
                            OFF
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-indigo-600/10 rounded-3xl p-6 border border-indigo-500/20">
                <h3 class="text-indigo-300 font-semibold text-sm mb-2 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                    How it works
                </h3>
                <p class="text-slate-400 text-sm leading-relaxed">
                    The browser uses <b>face-api.js</b> to analyze your camera feed locally. When a smile is detected, the status is pushed to your <b>Firebase Realtime Database</b>. The ESP8266 polls this data to toggle the LEDs.
                </p>
            </div>
        </div>
    </main>

    <footer class="max-w-4xl mx-auto mt-12 text-center text-slate-600 text-sm">
        ESP8266 Web Interface &bull; Realtime AI Detection
    </footer>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBfg4l53OaR2HYbO5rv2TmKBGnsb-VktK0",
            authDomain: "smile-dd182.firebaseapp.com",
            databaseURL: "https://smile-dd182-default-rtdb.firebaseio.com",
            projectId: "smile-dd182",
            storageBucket: "smile-dd182.firebasestorage.app",
            messagingSenderId: "83345671538",
            appId: "1:83345671538:web:a35b9c81c56c718cf749eb",
            measurementId: "G-PE8R9HRVQ1"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // State variables
        let isSmiling = false;
        let modelsLoaded = false;
        const video = document.getElementById('video');
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const cameraPlaceholder = document.getElementById('camera-placeholder');
        const smileOverlay = document.getElementById('smile-overlay');

        // UI Element handles
        const greenIcon = document.getElementById('green-led-icon');
        const greenBadge = document.getElementById('green-status-badge');
        const greenCard = document.getElementById('green-card');

        const redIcon = document.getElementById('red-led-icon');
        const redBadge = document.getElementById('red-status-badge');
        const redCard = document.getElementById('red-card');

        // Load Models
        async function loadModels() {
            try {
                updateStatus('Loading AI Models...', 'bg-yellow-500');
                const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
                ]);
                modelsLoaded = true;
                updateStatus('Models Ready. Starting Camera...', 'bg-blue-500');
                startVideo();
            } catch (err) {
                console.error(err);
                updateStatus('Error loading AI models.', 'bg-red-600');
            }
        }

        function updateStatus(text, colorClass) {
            statusText.innerText = text;
            statusDot.className = `w-3 h-3 rounded-full ${colorClass}`;
        }

        function startVideo() {
            navigator.mediaDevices.getUserMedia({ video: {} })
                .then(stream => {
                    video.srcObject = stream;
                    video.classList.remove('hidden');
                    cameraPlaceholder.classList.add('hidden');
                    updateStatus('Detecting Smiles...', 'bg-green-500 animate-pulse');
                    onPlay();
                })
                .catch(err => {
                    console.error(err);
                    updateStatus('Camera Access Denied.', 'bg-red-600');
                });
        }

        async function onPlay() {
            if (video.paused || video.ended || !modelsLoaded) {
                return setTimeout(() => onPlay(), 500);
            }

            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();

            if (detections && detections.length > 0) {
                const happyValue = detections[0].expressions.happy;
                const currentlySmiling = happyValue > 0.7;

                if (currentlySmiling !== isSmiling) {
                    isSmiling = currentlySmiling;
                    updateUI(isSmiling);
                    updateFirebase(isSmiling);
                }
            }

            setTimeout(() => onPlay(), 300); // 333ms = 3 times per second
        }

        function updateUI(smiling) {
            if (smiling) {
                smileOverlay.classList.remove('hidden');
                // Green LED ON
                greenIcon.className = "w-12 h-12 rounded-xl flex items-center justify-center bg-green-500 text-white shadow-[0_0_20px_rgba(34,197,94,0.4)] transition-all duration-300";
                greenBadge.className = "px-3 py-1 rounded-full text-xs font-bold bg-green-500/20 text-green-400 transition-all";
                greenBadge.innerText = "ON";
                greenCard.classList.add('border-green-500/50');
                
                // Red LED OFF
                redIcon.className = "w-12 h-12 rounded-xl flex items-center justify-center bg-slate-800 text-slate-500 transition-all duration-300";
                redBadge.className = "px-3 py-1 rounded-full text-xs font-bold bg-slate-800 text-slate-600 transition-all";
                redBadge.innerText = "OFF";
                redCard.classList.remove('border-red-500/50');
            } else {
                smileOverlay.classList.add('hidden');
                // Green LED OFF
                greenIcon.className = "w-12 h-12 rounded-xl flex items-center justify-center bg-slate-800 text-slate-500 transition-all duration-300";
                greenBadge.className = "px-3 py-1 rounded-full text-xs font-bold bg-slate-800 text-slate-600 transition-all";
                greenBadge.innerText = "OFF";
                greenCard.classList.remove('border-green-500/50');

                // Red LED ON
                redIcon.className = "w-12 h-12 rounded-xl flex items-center justify-center bg-red-500 text-white shadow-[0_0_20px_rgba(239,68,68,0.4)] transition-all duration-300";
                redBadge.className = "px-3 py-1 rounded-full text-xs font-bold bg-red-500/20 text-red-400 transition-all";
                redBadge.innerText = "ON";
                redCard.classList.add('border-red-500/50');
            }
        }

        function updateFirebase(smiling) {
            db.ref('ledStatus').set({
                green: smiling ? 1 : 0,
                red: smiling ? 0 : 1,
                lastUpdate: Date.now()
            }).catch(err => console.error("Firebase Update Error:", err));
        }

        // Initialize on window load
        window.addEventListener('load', loadModels);
    </script>
</body>
</html>
